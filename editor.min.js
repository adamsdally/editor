"use strict";function buildSelection(e){console.log("..........Range......."),console.log(e);var t,n,r=[],o=[],i=[];if(e.startContainer.length==e.startOffset){for(console.log("...at end of start"),next=e.startContainer.nextSibling?e.startContainer.nextSibling:e.startContainer.parentElement.nextSibling;next.firstChild;)next=next.firstChild;console.log(next),console.log(next.length),e.setStart(next,0),console.log(e)}if(0==e.endOffset){for(console.log("...at beginning of end"),previous=e.endContainer.previousSibling?e.endContainer.previousSibling:e.endContainer.parentElement.previousSibling;previous.lastChild;)previous=previous.lastChild;console.log(previous),console.log(previous.innerHTML),console.log(previous.length),e.setEnd(previous,previous.length),console.log(e)}if(e.startContainer==e.endContainer)return r.push(0==e.startOffset&&e.endOffset==e.endContainer.length?1==e.startContainer.parentElement.childNodes.length?{node:e.startContainer.parentElement}:{node:e.startContainer}:{node:e.startContainer,startOffset:e.startOffset,endOffset:e.endOffset}),r;for(t=e.startContainer,n=e.endContainer;t.parentElement!=e.commonAncestorContainer;)t=t.parentElement;for(;n.parentElement!=e.commonAncestorContainer;)n=n.parentElement;for(current=e.startContainer,e.startOffset&&(current.length>e.startOffset&&o.push({node:current,startOffset:e.startOffset}),current=current.nextSibling?current.nextSibling:current.parentElement);current!=t&&current!=n;)current.previousSibling&&current.nextSibling?(o.push({node:current}),current=current.nextSibling):current.previousSibling&&!current.nextSibling?(o.push({node:current}),current=current.parentElement):current=current.parentElement;for(current=e.endContainer,e.endOffset&&e.endOffset!=e.endContainer.length&&(i.push({node:current,endOffset:e.endOffset}),current=current.previousSibling?current.previousSibling:current.parentElement);current!=n&&current!=t;)current.previousSibling&&current.nextSibling?(i.push({node:current}),current=current.previousSibling):!current.previousSibling&&current.nextSibling?(i.push({node:current}),current=current.parentElement):current=current.parentElement;if(0==o.length&&0==i.length&&!t.previousElementSibling&&!n.nextElementSibling)return r.push({node:e.commonAncestorContainer}),r;for(0==o.length&&o.push({node:t}),0==i.length&&i.push({node:n}),current=t;current.nextSibling!=n;)current=current.nextSibling,r.push({node:current});return r.concat(o,i)}function Editor(e){function t(){}t.prototype=EditorPrototype;var n=new t;return n.config=e,n}function getApplyableElementsInParent(e,t){var n,r=e.children,o=[];for(n=0;n<r.length;n++)isActionable(r[n],t)&&o.push(r[n]);return console.log(o),o}function isActionable(e,t){return t.class&&e.classList.contains(t.class)?!0:void 0}var config={debug:!0},config1={debug:!1},EditorPrototype=window.EditorPrototype||{};EditorPrototype.htmlEncode=function(e){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"'").replace(/</g,"&lt;").replace(/>/g,"&gt;")},EditorPrototype.joinAdjacentElements=function(){var e,t,n=element.previousSibling,r=element.nextSibling,o=element.parentElement;n&&1==n.nodeType&&n.tagName==element.tagName&&n.className==element.className&&n.style==element.style&&(n.innerHTML+=element.innerHTML,o.removeChild(element),element=n),r&&1==r.nodeType&&r.tagName==element.tagName&&r.className==element.className&&r.style==element.style&&(element.innerHTML+=r.innerHTML,o.removeChild(r)),1==o.children.length&&inlineElements.indexOf(o.tagName)>=0&&(e=o.cloneNode(),t=element.cloneNode(),e.innerHTML=element.innerHTML,t.appendChild(e),o.parentElement.appendChild(t),o.removeChild(element),o.parentElement.removeChild(o),joinAdjacentElements(t))},EditorPrototype.createParentElement=function(e,t){var n=document.createElement(t);return e.parentElement.insertBefore(n,e),n.appendChild(e),n},EditorPrototype.createChildElement=function(e,t){var n=document.createElement(t);n.innerHTML=e.innerHTML,e.innerHTML="",e.appendChild(n)};var EditorPrototype=window.EditorPrototype||{};EditorPrototype.start=function(e){var t=this,n=!0,r=!1;if(this.el=e.el,this.controlsEl=e.controlsEl,this.actions=e.actions,this.blockElements=e.blockElements,this.inlineElements=e.inlineElements,this.selection=window.getSelection(),this.range=null,this.el.addEventListener("mouseup",function(){var e=t.selection.getRangeAt(0);n=t.isRestricted(e.startContainer,t.actions.input)?!1:!0,t.resetControls()}),this.el.addEventListener("paste",function(e){n||e.preventDefault()}),this.el.addEventListener("keypress",function(e){var o,i,l;if(r=!1,e.ctrlKey)return!0;if(-1==[37,38,39,40].indexOf(e.keyCode)&&!n)return e.preventDefault();if(-1!=[8,46].indexOf(e.keyCode)){if(o=t.selection.getRangeAt(0),8==e.keyCode&&0==o.startOffset)for(i=o.startContainer,l=i.previousElementSibling;!l||!i;)i=i.parentElement,l=i.previousElementSibling;if(46==e.keyCode&&o.startOffset==o.startContainer.length)for(i=o.startContainer,l=i.nextElementSibling;!l||"MAIN"==i.tagName;)i=i.parentElement,l=i.nextElementSibling;l&&isRestricted(l,t.actions.input)&&e.preventDefault()}}),this.el.addEventListener("keyup",function(e){var r;-1!=[37,38,39,40].indexOf(e.keyCode)&&(r=t.selection.getRangeAt(0),n=t.isRestricted(r.startContainer,t.actions.input)?!1:!0)}),this.controlsEl.addEventListener("click",function(e){var n=null;return e.preventDefault(),"A"!=e.target.tagName?!1:(t.l("Click"),e.target.dataset.action&&t.actions[e.target.dataset.action]?(n=t.actions[e.target.dataset.action],t.perform(n),!1):!1)}),this.controlsEl.addEventListener("change",function(e){var n=null;return e.preventDefault(),"SELECT"!=e.target.tagName?!1:(t.l("Change"),e.target.dataset.action&&t.actions[e.target.dataset.action]?(n=t.actions[e.target.dataset.action],n.input&&(n.value=e.target.options[e.target.selectedIndex].value),void t.perform(n)):!1)}),null==this.config)throw"No configuration file found.";if(this.config.debug){var o=document.createElement("ARTICLE");this.el.parentElement.insertBefore(o,null)}};var EditorPrototype=window.EditorPrototype||{},joinx=0;EditorPrototype.l=function(e){var t;return this.config.debug?(e?(console.log("=============="+e+"================"),console.log("===================================")):console.log("l------------------"),t=document.getElementsByTagName("article")[0].innerHTML,void(document.getElementsByTagName("article")[0].innerHTML="<p>"+this.htmlEncode(this.el.innerHTML)+"</p>"+t)):!1},EditorPrototype.isRestricted=function(e,t){var n;if(t.restricted)for(n=e;"MAIN"!=n.tagName;){if(-1!=t.restricted.indexOf(n.tagName))return!0;n=n.parentElement}return!1},EditorPrototype.resetControls=function(){var e,t,n=this.selection.getRangeAt(0),r=buildSelection(n),o=null,i=0,l=0,s=null,a=[],c=null;for(joinx=0,o=this.controlsEl.getElementsByTagName("SELECT"),i=0;i<o.length;i++)o[i].dataset.action&&this.actions[o[i].dataset.action]&&(s=this.actions[o[i].dataset.action],s.element=o[i],s.value=null,a.push(s));for(t=JSON.parse(JSON.stringify(a)),i=0;i<r.length;i++)console.log("{{Next Node}}"),e=r[i],console.log(e),c=e.startOffset||e.endOffset&&e.node.length>e.endOffset?!0:!1,this.joinValues(a,this.determineValues(e.node,JSON.parse(JSON.stringify(t)),c));for(i=0;i<a.length;i++)for(s=a[i],null==s.value&&(s.value=""),l=0;l<s.element.options.length;++l)if(s.element.options[l].value===s.value){s.element.selectedIndex=l;break}},EditorPrototype.joinValues=function(e,t){console.log("### Join Values ###"),console.log(joinx++);var n=0;for(n=0;n<e.length;n++)null==e[n].value&&null!=t[n].value&&(e[n].value=t[n].value),e[n].value!=t[n].value&&(e[n].value="")},EditorPrototype.determineValues=function(e,t,n){console.log("Determing"),console.log(e);var r,o=0,i=!1;if(1==e.nodeType)for(o=0;o<t.length;o++)t[o].attribute&&e.style[t[o].attribute]&&(t[o].value=e.style[t[o].attribute]);if(n){for(console.log("Entering Part");-1==this.blockElements.indexOf(e.tagName);){for(r=JSON.parse(JSON.stringify(t)),e=e.parentElement,i=!1,o=0;o<r.length;o++)r[o].attribute&&e.style[r[o].attribute]&&(i=!0,r[o].value=e.style[r[o].attribute]);i&&this.joinValues(t,r)}for(o=0;o<t.length;o++)null==t[o].value&&(t[o].value="")}return t},EditorPrototype.apply=function(e,t){console.log("Applying:"),console.log(""+e.innerHTML),console.log(JSON.stringify(t));var n,r,o;if(t.negate){if(t.input?(console.log("Negating an input"),e.style[t.attribute]=t.value):e.classList.toggle(t["class"],!1),this.blockElements.indexOf(e.tagName)>=0)for(o=!0;o;)n=e.getElementsByClassName(t.class),console.log("NOT CHECKING FOR ATTRIBUTES"),n[0]?apply(n[0],t):o=!1;else if(this.inlineElements.indexOf(e.tagName)>=0&&(console.log("NOT CHECKING FOR ATTRIBUTES"),""==e.className)){for(r=e.parentElement;e.firstChild;)e.parentElement.insertBefore(e.firstChild,e);e.parentElement.removeChild(e)}return this.l()}return t.input?e.style[t.attribute]=t.value:e.classList.toggle(t["class"],!0),this.l()},EditorPrototype.downwards=function(e,t,n,r,o){console.log("!!Downwards:"),console.log(e.innerHTML),console.log(JSON.stringify(t));var i,l,s,a,c,u,g,d=e.parentElement;if(this.isRestricted(e,t))return!1;if(-1!=this.blockElements.indexOf(e.tagName))return this.apply(e,t);if(-1!=this.inlineElements.indexOf(e.tagName))return this.apply(e,t);if(3==e.nodeType&&e.nodeValue.trim())if(r&&e.length>r&&(e.splitText(r),l=e.nextSibling),n&&(e=e.splitText(n),s=e.previousSibling),t.negate){for(a=e,c=JSON.parse(JSON.stringify(t)),console.log("Should I clear block?");c.negate&&-1==this.blockElements.indexOf(a.tagName);)console.log("try"),console.log(JSON.stringify(a)),a=a.parentElement,hasProperty(a,t)&&(console.log("!clear block"),this.apply(a,t),c.negate=!1);this.config.debug&&(console.log("Action 2, next, previous:"),console.log(JSON.stringify(c)),console.log(JSON.stringify(l)),console.log(JSON.stringify(s))),c.negate||(l&&(nextNode=this.createParentElement(l,"SPAN"),this.apply(nextNode,c)),s&&(previousNode=this.createParentElement(s,"SPAN"),this.apply(previousNode,c)))}else{var f=!1,p=!1;if(e.nextSibling&&3!=e.nextSibling.nodeType&&(f=e.nextElementSibling.className==t.class),e.previousSibling&&3!=e.previousSibling.nodeType&&(p=e.previousElementSibling.className==t.class),console.log(JSON.stringify(e)),f&&!p){var l=e.nextElementSibling;l.insertBefore(e,l.firstChild)}else if(!f&&p){var s=e.previousElementSibling;s.insertBefore(e,null)}else if(f&&p){var s=e.previousElementSibling,l=e.nextElementSibling;s.insertBefore(e,null),s.insertBefore(l.firstChild,null),s.parentElement.removeChild(l)}else e=this.createParentElement(e,"SPAN"),this.apply(e,t);d.normalize(),u=d.firstChild,1==d.childNodes.length&&(d.className=u.className,d.insertBefore(u.firstChild,null),d.removeChild(u))}if(g=e.children,o.push(e.tagName),this.l(),g)for(i=0;i<g.length;i++)this.downwards(g[i],t,!1,!1,o)},EditorPrototype.hasProperty=function(e,t,n){if(t.input){if(e.style[t.attribute])return!0}else{if(e.classList.contains(t.class))return!0;if(n&&e.getElementsByClassName(t.class).length)return!0}return!1},EditorPrototype.perform=function(e){var t,n=0,r=this.selection.getRangeAt(0),o=buildSelection(r),i=this;for(config.debug&&console.log(o),e.negate=!1;0==e.negate&&n<o.length;){if(t=o[n].node,console.log("!Trying to negate"),console.log(JSON.stringify(t)),1==t.nodeType&&(e.negate=this.hasProperty(t,e,!0)),3==t.nodeType)for(t=t.parentElement;"MAIN"!=t.tagName;)e.negate=this.hasProperty(t,e,!1),t=t.parentElement;n++}console.log(e.negate);var l=saveSelection(this.el);o.forEach(function(t){console.log("++++++++++++Current++++++++++++++++"),console.log(t),i.downwards(t.node,e,t.startOffset,t.endOffset,[]),t.node.normalize(),console.log(t)}),restoreSelection(this.el,l),console.log("cSel repeat"),console.log(JSON.stringify(o))};var saveSelection,restoreSelection;window.getSelection&&document.createRange?(saveSelection=function(e){var t=window.getSelection().getRangeAt(0),n=t.cloneRange();n.selectNodeContents(e),n.setEnd(t.startContainer,t.startOffset);var r=n.toString().length;return{start:r,end:r+t.toString().length}},restoreSelection=function(e,t){var n=0,r=document.createRange();r.setStart(e,0),r.collapse(!0);for(var o,i=[e],l=!1,s=!1;!s&&(o=i.pop());)if(3==o.nodeType){var a=n+o.length;!l&&t.start>=n&&t.start<=a&&(r.setStart(o,t.start-n),l=!0),l&&t.end>=n&&t.end<=a&&(r.setEnd(o,t.end-n),s=!0),n=a}else for(var c=o.childNodes.length;c--;)i.push(o.childNodes[c]);var u=window.getSelection();u.removeAllRanges(),u.addRange(r)}):document.selection&&(saveSelection=function(e){var t=document.selection.createRange(),n=document.body.createTextRange();n.moveToElementText(e),n.setEndPoint("EndToStart",t);var r=n.text.length;return{start:r,end:r+t.text.length}},restoreSelection=function(e,t){var n=document.body.createTextRange();n.moveToElementText(e),n.collapse(!0),n.moveEnd("character",t.end),n.moveStart("character",t.start),n.select()});
//# sourceMappingURL=editor.min.js.map
